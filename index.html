<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">

  <!-- CSP ultra-segura con nonce -->
  <script>
    const nonce = btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(16))));
    document.head.insertAdjacentHTML(
      "beforeend",
      `<meta http="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' https://cdn.jsdelivr.net 'nonce-${nonce}';
          style-src 'self' 'unsafe-inline';
          img-src 'self' blob: data:;
          connect-src *;
          frame-ancestors 'none';
          media-src *;
          object-src 'none';
          base-uri 'self';
        ">
      `
    );
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asistente Visual Inteligente</title>

  <!-- TensorFlow -->
  <script nonce="">
    document.currentScript.setAttribute("nonce", nonce);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0" nonce=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd" nonce=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface" nonce=""></script>

  <style>
    body {
      background: #0d1117;
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 20px 0;
      font-family: Arial;
    }
    video {
      width: 90%;
      max-width: 480px;
      border-radius: 14px;
      margin-top: 15px;
    }
    #status {
      margin-top: 20px;
      font-size: 1.3em;
      background: rgba(255,255,255,0.12);
      padding: 10px 20px;
      border-radius: 10px;
      display: inline-block;
    }
    #startButton {
      font-size: 1.5em;
      padding: 12px 25px;
      background: #2ea043;
      border: none;
      border-radius: 15px;
      color: white;
      cursor: pointer;
    }
    #notify {
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      padding: 10px 18px;
      border-radius: 12px;
      opacity: 0;
      transition: 0.25s;
    }
  </style>
</head>

<body>

<h2>üëÅ Asistente Visual Inteligente</h2>
<button id="startButton">Iniciar Asistente</button>
<video id="video" autoplay playsinline></video>

<div id="status">Esperando inicio...</div>
<div id="notify"></div>

<script nonce="">
document.currentScript.setAttribute("nonce", nonce);

/* ---------------------------------------
   NOTIFICACIONES
----------------------------------------*/
function notify(msg) {
  const n = document.getElementById("notify");
  n.textContent = msg;
  n.style.opacity = 1;
  setTimeout(() => n.style.opacity = 0, 2200);
}

/* ---------------------------------------
   VARIABLES
----------------------------------------*/
let video = document.getElementById("video");
let statusDiv = document.getElementById("status");
let startBtn = document.getElementById("startButton");

let cocoModel = null;
let blazeModel = null;

let speaking = false;
let lastMessage = "";
let lastFrame = 0;

/* ---------------------------------------
   VOZ
----------------------------------------*/
function speak(msg) {
  if (speaking || msg === lastMessage) return;
  let u = new SpeechSynthesisUtterance(msg);
  u.lang = "es-MX";
  speaking = true;
  u.onend = () => (speaking = false);
  speechSynthesis.speak(u);

  lastMessage = msg;
  statusDiv.textContent = msg;
}

/* ---------------------------------------
   C√ÅMARA OPTIMIZADA PARA M√ìVILES
----------------------------------------*/
async function setupCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: "environment",
        width: { ideal: 320 },   // üî• Mucho mejor rendimiento en m√≥vil
        height: { ideal: 240 }   // üî• 
      }
    });

    video.srcObject = stream;

  } catch (e) {
    speak("No se puede acceder a la c√°mara.");
    throw e;
  }

  return new Promise(res => (video.onloadedmetadata = () => res()));
}

/* ---------------------------------------
   CARGAR MODELOS
----------------------------------------*/
async function loadModels() {
  statusDiv.textContent = "Cargando modelos‚Ä¶";
  await tf.ready(); // üî• Necesario en m√≥vil

  cocoModel = await cocoSsd.load({ base: "lite_mobilenet_v2" });
  blazeModel = await blazeface.load();

  statusDiv.textContent = "Modelos cargados ‚úî";
}

/* ---------------------------------------
   DETECCI√ìN ‚Äì OPTIMIZADA PARA CELULAR
----------------------------------------*/
async function detectFrame(timestamp) {

  // Ajuste autom√°tico: si el m√≥vil va lento, baja frecuencia
  if (timestamp - lastFrame < 350) {
    return requestAnimationFrame(detectFrame);
  }
  lastFrame = timestamp;

  const coco = await cocoModel.detect(video);
  const blaze = await blazeModel.estimateFaces(video, false);

  const preds = [...coco];

  blaze.forEach(face => {
    preds.push({
      class: "person",
      score: 0.9,
      bbox: [
        face.topLeft[0],
        face.topLeft[1],
        face.bottomRight[0] - face.topLeft[0],
        face.bottomRight[1] - face.topLeft[1]
      ]
    });
  });

  let personClose = false,
      vehicleClose = false,
      wallDetected = false,
      groundObstacle = false;

  preds.forEach(obj => {
    let [x, y, w, h] = obj.bbox;
    let area = w * h;

    if (obj.class === "person" && area > 18000) personClose = true;

    if (["car","truck","bus"].includes(obj.class) && area > 25000)
      vehicleClose = true;

    if (area > video.videoWidth * video.videoHeight * 0.55)
      wallDetected = true;

    if ((y + h) > video.videoHeight * 0.65 && area > 9000)
      groundObstacle = true;
  });

  let msg = "Camino libre.";
  if (wallDetected) msg = "Pared al frente, det√©ngase.";
  else if (personClose) msg = "Persona al frente, cuidado.";
  else if (vehicleClose) msg = "Veh√≠culo cerca, precauci√≥n.";
  else if (groundObstacle) msg = "Obst√°culo en el camino.";

  speak(msg);

  requestAnimationFrame(detectFrame);
}

/* ---------------------------------------
   INICIO
----------------------------------------*/
async function startApp() {
  startBtn.style.display = "none";
  notify("Activando c√°mara‚Ä¶");

  await setupCamera();
  notify("C√°mara lista");

  await loadModels();
  notify("Asistente iniciado");

  requestAnimationFrame(detectFrame);
}

startBtn.addEventListener("click", startApp);

</script>
</body>
</html>
