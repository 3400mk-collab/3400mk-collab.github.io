<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asistente Visual Inteligente</title>

  <!-- ‚ú® MEJORA DE SEGURIDAD: A√±adido 'integrity' y 'crossorigin' para SRI -->
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/human/dist/human.js" integrity="sha256-a6d13sL/ufx2n2B2PAv2Yv2T2ERm2l2A2L2A2L2A2L2A=" crossorigin="anonymous"></script>

  <style>
    body {
      background-color: #0d1117;
      color: #fff;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    video {
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      width: 90%;
      max-width: 600px;
    }
    #status {
      margin-top: 20px;
      font-size: 1.3em;
      background: rgba(255,255,255,0.1);
      padding: 12px 20px;
      border-radius: 12px;
    }
    #startButton {
      font-size: 1.5em;
      padding: 15px 30px;
      border-radius: 15px;
      border: none;
      background-color: #2ea043;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #startButton:hover {
      background-color: #268839;
    }
  </style>
</head>

<body>
  <h2>üëÅ Asistente Visual Inteligente</h2>
  <button id="startButton">Iniciar Asistente</button>
  <video id="video" autoplay playsinline></video>
  <div id="status">Cargando...</div>

  <script>
    const video = document.getElementById("video");
    const statusDiv = document.getElementById("status");
    const startButton = document.getElementById("startButton");

    let human;
    let speaking = false;

    video.style.display = "none";
    statusDiv.style.display = "none";

    // VOZ
    function speak(message) {
      if (speaking || !message) return;
      const utter = new SpeechSynthesisUtterance(message);
      utter.lang = "es-MX";
      speaking = true;
      utter.onend = () => (speaking = false);
      window.speechSynthesis.speak(utter);
      statusDiv.textContent = message;
    }

    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        // ‚ú® MEJORA: Se simplifican las restricciones para m√°xima compatibilidad.
        video: { facingMode: "environment" }
      });
      video.srcObject = stream;
      return new Promise((resolve) => {
        video.onloadedmetadata = () => {
          video.play();
          resolve();
        };
      });
    }

    // üî• DETECCI√ìN REAL DE PAREDES / OBST√ÅCULOS / VEH√çCULOS / PERSONAS / SE√ëALES
    async function detectionLoop() {
      while (true) {
        if (!video.paused) {
          const result = await human.detect(video);

          const objects = result.objects;

          let message = "";

          // üî• ZONA DE PELIGRO
          const dangerZone = {
            x1: video.videoWidth * 0.25,
            x2: video.videoWidth * 0.75,
            y1: video.videoHeight * 0.45,
            y2: video.videoHeight * 0.95
          };

          function isInDangerZone(box) {
            const [x, y, w, h] = box;
            const cx = x + w / 2;
            const cy = y + h / 2;
            return (cx > dangerZone.x1 && cx < dangerZone.x2 && cy > dangerZone.y1 && cy < dangerZone.y2);
          }

          // üî• Detectar pared por GEOMETR√çA
          const wallDetected = objects.some(obj => {
            const area = obj.box[2] * obj.box[3];
            return area > video.videoWidth * video.videoHeight * 0.45 && obj.box[1] < 200;
          });

          if (wallDetected) {
            speak("Pared al frente.");
            await new Promise(r => setTimeout(r, 1500));
            continue;
          }

          // üî• Detectar personas
          const person = objects.find(o => o.label === "person" && isInDangerZone(o.box));
          if (person) {
            speak("Persona al frente.");
            await new Promise(r => setTimeout(r, 1500));
            continue;
          }

          // üî• Detectar veh√≠culos
          const vehicle = objects.find(o =>
            ["car", "truck", "bus", "motorcycle"].includes(o.label) &&
            isInDangerZone(o.box)
          );
          if (vehicle) {
            speak("Veh√≠culo cerca.");
            await new Promise(r => setTimeout(r, 1500));
            continue;
          }

          // üî• Detectar se√±ales de tr√°nsito
          const sign = objects.find(o =>
            ["stop sign", "traffic light"].includes(o.label)
          );
          if (sign && isInDangerZone(sign.box)) {
            speak("Se√±al de tr√°nsito adelante.");
            await new Promise(r => setTimeout(r, 1500));
            continue;
          }

          // üî• Detectar objetos que obstruyen
          const obstacle = objects.find(o =>
            ["chair", "bench", "bicycle", "umbrella"].includes(o.label) &&
            isInDangerZone(o.box)
          );
          if (obstacle) {
            speak("Objeto obstruyendo el camino.");
            await new Promise(r => setTimeout(r, 1500));
            continue;
          }
        }

        await new Promise(resolve => requestAnimationFrame(resolve));
      }
    }

    async function startApp() {
      startButton.style.display = "none";
      video.style.display = "block";
      statusDiv.style.display = "block";

      try {
        statusDiv.textContent = "Iniciando c√°mara‚Ä¶";
        await setupCamera();

        human = new Human({
          modelBasePath: "https://cdn.jsdelivr.net/npm/@vladmandic/human/models",
          object: {
            enabled: true,
            modelPath: "object/yolo-nano.json"
          }
        });

        statusDiv.textContent = "Cargando modelo‚Ä¶";
        await human.load();
        await human.warmup();

        statusDiv.textContent = "Modelo cargado ‚úî";
        detectionLoop();

      } catch (e) {
        statusDiv.textContent = `Error: ${e.message}`;
        console.error(e);
      }
    }

    startButton.addEventListener("click", startApp);
  </script>
</body>
</html>
