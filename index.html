<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Asistente Visual Inteligente - Versi√≥n Mejorada</title>

<!-- CSP funcional para TFJS + inline scripts -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self' https:;
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdn.jsdelivr.net/npm;
  script-src-elem 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdn.jsdelivr.net/npm;
  script-src-attr 'self' 'unsafe-inline' 'unsafe-eval';
  connect-src *;
  img-src 'self' blob: data:;
  media-src *;
  style-src 'self' 'unsafe-inline';
  object-src 'none';
">

<!-- TFJS y modelos desde CDN -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

<style>
:root{--green:#2ea043}
body{background:#0d1117;color:#fff;font-family:Segoe UI,Arial,sans-serif;margin:0;padding:18px;text-align:center}
h1{margin:6px 0 12px;font-size:1.1rem}
#startButton{font-size:1.1rem;padding:10px 22px;background:var(--green);border:none;border-radius:12px;color:#fff;cursor:pointer}
video{width:90%;max-width:480px;border-radius:12px;margin-top:12px;background:#000}
#status{margin-top:12px;display:inline-block;background:rgba(255,255,255,.08);padding:10px 14px;border-radius:10px}
#notify{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,.75);padding:8px 12px;border-radius:10px;opacity:0;transition:.25s;color:#fff}
#debugCanvas{position:fixed;right:12px;top:12px;width:160px;height:120px;border:1px solid rgba(255,255,255,.08);display:none}
</style>
</head>
<body>
<h1>üëÅ Asistente Visual Inteligente (Versi√≥n Mejorada)</h1>
<button id="startButton">Iniciar Asistente</button>
<video id="video" autoplay playsinline muted></video>
<div id="status">Esperando inicio...</div>
<div id="notify"></div>
<canvas id="debugCanvas"></canvas>

<script>
const startBtn = document.getElementById('startButton');
const statusDiv = document.getElementById('status');
const notifyBox = document.getElementById('notify');
const video = document.getElementById('video');
const debugCanvas = document.getElementById('debugCanvas');
const debugCtx = debugCanvas.getContext('2d');

let cocoModel=null, blazeModel=null;
let lastMessage='', lastSpokenMessage='';
let personCnt=0, vehicleCnt=0, wallCnt=0, obsLowCnt=0, obsMidCnt=0, obsHighCnt=0;
let leftCnt=0, centerCnt=0, rightCnt=0;
let lastFrameTime = 0;
const COUNTER_MAX = 12, THRESH_GO = 3, ZONE_THRESH = 3;
const MIN_OBJ_AREA_RATIO = 0.008, GENERIC_BIG_RATIO = 0.02;
const PERSON_MIN_RATIO = 0.012, VEHICLE_MIN_RATIO = 0.02, WALL_RATIO = 0.55;
let DEBUG = false;

function notify(msg){
  notifyBox.textContent=msg;
  notifyBox.style.opacity=1;
  setTimeout(()=>notifyBox.style.opacity=0,2200);
}

function speak(msg){
  if(!msg || msg===lastSpokenMessage) return;
  try{
    window.speechSynthesis?.cancel();
    const u = new SpeechSynthesisUtterance(msg);
    u.lang='es-MX';
    window.speechSynthesis.speak(u);
    lastSpokenMessage = msg;
    statusDiv.textContent = msg;
  }catch(e){ console.warn('TTS error', e); }
}

async function setupCamera(){
  const constraints = { audio:false, video:{ facingMode:'environment', width:320, height:240, frameRate:15 } };
  const stream = await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject = stream;
  await new Promise(res => video.onloadedmetadata = res);
  await video.play();
}

async function loadModels(){
  statusDiv.textContent = 'Cargando modelos...'; notify('Cargando modelos...');
  await tf.ready();
  cocoModel = await cocoSsd.load({ base:'lite_mobilenet_v2' });
  blazeModel = await blazeface.load();
  statusDiv.textContent = 'Modelos cargados ‚úî'; notify('Modelos listos');
}

function clamp(n,min=0,max=COUNTER_MAX){ return Math.max(min,Math.min(max,n)); }

function obstacleLevels(obj,vw,vh){
  const [x,y,w,h]=obj.bbox;
  const area=w*h, bottom=y+h;
  return {
    low: bottom>vh*0.70 && area>vw*vh*0.008,
    mid: (y+h/2)>vh*0.35 && (y+h/2)<=vh*0.70 && area>vw*vh*0.008,
    high: y<vh*0.25 && area>vw*vh*0.006,
    canJump: bottom>vh*0.70 && h<vh*0.15
  };
}

function zoneOccupancyFromPreds(preds,vw,vh){
  let left=false, center=false, right=false;
  const zoneAreaThr = Math.max(GENERIC_BIG_RATIO,0.01)*vw*vh;
  for(const obj of preds){
    const [x,y,w,h]=obj.bbox, cx=x+w/2;
    if(w*h < zoneAreaThr) continue;
    if(cx<vw/3) left=true;
    else if(cx>2*vw/3) right=true;
    else center=true;
  }
  return {left,center,right};
}

async function detectLoop(ts){
  ts = ts||performance.now();
  const RATE_MS=170;
  if(ts-lastFrameTime<RATE_MS) return requestAnimationFrame(detectLoop);
  lastFrameTime=ts;
  if(!cocoModel||!blazeModel) return requestAnimationFrame(detectLoop);

  let cocoDet=[], blazeDet=[];
  try{
    cocoDet = await cocoModel.detect(video);
    blazeDet = await blazeModel.estimateFaces(video,false);
  }catch(e){ return requestAnimationFrame(detectLoop); }

  const preds=[...cocoDet];
  blazeDet.forEach(face => preds.push({ class:'person', score:0.9, bbox:[ face.topLeft[0], face.topLeft[1], face.bottomRight[0]-face.topLeft[0], face.bottomRight[1]-face.topLeft[1] ] }));

  const vw = video.videoWidth || 320, vh = video.videoHeight || 240;
  let personPresent=false, vehiclePresent=false, wallPresent=false, anyLow=false, anyMid=false, anyHigh=false, canJump=false;
  let genericObstaclePresent=false, bigFurniturePresent=false;
  const FURNITURE_CLASSES=new Set(['chair','couch','sofa','bed','dining table','table','door','bench','wardrobe','tv']);

  preds.forEach(obj=>{
    const [x,y,w,h]=obj.bbox, area=w*h, areaRatio=area/(vw*vh);
    if(obj.class==='person' && areaRatio>Math.max(PERSON_MIN_RATIO,12000/(vw*vh))) personPresent=true;
    if(['car','truck','bus','motorcycle','bicycle'].includes(obj.class) && areaRatio>VEHICLE_MIN_RATIO) vehiclePresent=true;
    if(areaRatio>WALL_RATIO) wallPresent=true;
    if(FURNITURE_CLASSES.has(obj.class) && areaRatio>GENERIC_BIG_RATIO) bigFurniturePresent=true;
    if(areaRatio>=MIN_OBJ_AREA_RATIO) genericObstaclePresent=true;
    const levels=obstacleLevels(obj,vw,vh);
    if(levels.low) anyLow=true;
    if(levels.mid) anyMid=true;
    if(levels.high) anyHigh=true;
    if(levels.canJump) canJump=true;
  });

  const zones=zoneOccupancyFromPreds(preds,vw,vh);
  leftCnt=clamp(zones.left?leftCnt+1:leftCnt-1);
  centerCnt=clamp(zones.center?centerCnt+1:centerCnt-1);
  rightCnt=clamp(zones.right?rightCnt+1:rightCnt-1);

  personCnt=clamp(personPresent?personCnt+1:personCnt-1);
  vehicleCnt=clamp(vehiclePresent?vehicleCnt+1:vehicleCnt-1);
  wallCnt=clamp(wallPresent?wallCnt+1:wallCnt-1);
  obsLowCnt=clamp(anyLow?obsLowCnt+1:obsLowCnt-1);
  obsMidCnt=clamp(anyMid?obsMidCnt+1:obsMidCnt-1);
  obsHighCnt=clamp(anyHigh?obsHighCnt+1:obsHighCnt-1);

  const personStable=personCnt>=THRESH_GO, vehicleStable=vehicleCnt>=THRESH_GO, wallStable=wallCnt>=THRESH_GO;
  const lowStable=obsLowCnt>=THRESH_GO, midStable=obsMidCnt>=THRESH_GO, highStable=obsHighCnt>=THRESH_GO;
  const leftStable=leftCnt>=ZONE_THRESH, centerStable=centerCnt>=ZONE_THRESH, rightStable=rightCnt>=ZONE_THRESH;

  let message='Camino libre.';
  if(wallStable) message='Pared al frente, det√©ngase.';
  else if(personStable) message='Persona al frente, cuidado.';
  else if(vehicleStable) message='Veh√≠culo cerca, precauci√≥n.';
  else if(highStable) message='Objeto alto al frente ‚Äî cuidado.';
  else if(midStable) message='Objeto a media altura al frente ‚Äî cuidado.';
  else if(lowStable) message=canJump ? 'Objeto bajo al frente, puedes saltarlo.' : 'Objeto en el suelo obstruyendo el paso.';
  else if(bigFurniturePresent && genericObstaclePresent) message='Obst√°culo grande al frente (mueble/puerta) ‚Äî cuidado.';
  else if(genericObstaclePresent) message='Objeto detectado al frente.';
  else if(centerStable){
    if(!leftStable && rightStable) message='Centro ocupado. Puedes intentar ir por la izquierda.';
    else if(!rightStable && leftStable) message='Centro ocupado. Puedes intentar ir por la derecha.';
    else if(!leftStable && !rightStable) message='Centro ocupado. Izquierda y derecha parecen libres, intenta girar con cuidado.';
    else message='Centro ocupado y laterales tambi√©n ocupados, det√©ngase y espere.';
  }

  if(message!==lastMessage){ lastMessage=message; statusDiv.textContent=message; }
  if(message!==lastSpokenMessage) speak(message);

  if(DEBUG && debugCtx){
    debugCanvas.style.display='block';
    debugCanvas.width=320; debugCanvas.height=240;
    debugCtx.clearRect(0,0,debugCanvas.width,debugCanvas.height);
    debugCtx.strokeStyle='rgba(0,255,0,0.6)'; debugCtx.lineWidth=1;
    preds.slice(0,8).forEach(p=>{
      const [x,y,w,h]=p.bbox;
      debugCtx.strokeRect(x*(debugCanvas.width/vw),y*(debugCanvas.height/vh),w*(debugCanvas.width/vw),h*(debugCanvas.height/vh));
      debugCtx.fillStyle='rgba(0,255,0,0.06)';
      debugCtx.fillRect(x*(debugCanvas.width/vw),y*(debugCanvas.height/vh),w*(debugCanvas.width/vw),h*(debugCanvas.height/vh));
    });
  }

  requestAnimationFrame(detectLoop);
}

async function startApp(){
  startBtn.disabled=true; startBtn.style.opacity='0.6';
  notify('Solicitando c√°mara...'); statusDiv.textContent='Solicitando c√°mara...';
  try{
    await setupCamera(); notify('C√°mara activada'); statusDiv.textContent='C√°mara lista';
    await loadModels();
    personCnt=vehicleCnt=wallCnt=obsLowCnt=obsMidCnt=obsHighCnt=0;
    leftCnt=centerCnt=rightCnt=0; lastMessage=''; lastSpokenMessage='';
    notify('Asistente iniciado'); statusDiv.textContent='Asistente iniciado';
    requestAnimationFrame(detectLoop);
  }catch(e){
    console.error('Error iniciando app:',e);
    statusDiv.textContent='Error cr√≠tico. Revisa permisos/consola.';
    notify('No se pudo iniciar. Revisa permisos.');
    startBtn.disabled=false; startBtn.style.opacity='1';
  }
}

startBtn.addEventListener('click',startApp);
</script>
</body>
</html>

