<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asistente Visual Inteligente</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <style>
    body {
      background-color: #0d1117;
      color: #fff;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    video {
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      width: 90%;
      max-width: 600px;
    }
    #status {
      margin-top: 20px;
      font-size: 1.3em;
      background: rgba(255,255,255,0.1);
      padding: 12px 20px;
      border-radius: 12px;
    }
    #startButton {
      font-size: 1.5em;
      padding: 15px 30px;
      border-radius: 15px;
      border: none;
      background-color: #2ea043;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #startButton:hover {
      background-color: #268839;
    }
  </style>
</head>
<body>
  <h2>üëÅ Asistente Visual Inteligente</h2>
  <button id="startButton">Iniciar Asistente</button>
  <video id="video" autoplay playsinline></video>
  <div id="status">Cargando modelo...</div>

  <script>
    const video = document.getElementById('video');
    const statusDiv = document.getElementById('status');
    const startButton = document.getElementById('startButton');
    let model;
    let lastMessage = "";
    let lastDetectionTime = 0;
    let speaking = false;
    let detectionLoopId; // Para controlar el bucle de detecci√≥n

    // Ocultar elementos al inicio para que el bot√≥n de inicio sea el protagonista
    video.style.display = 'none';
    statusDiv.style.display = 'none';

    // Activar voz del navegador
    function speak(message) {
      if (speaking || message === lastMessage) return;
      const utterance = new SpeechSynthesisUtterance(message);
      utterance.lang = 'es-MX';
      speaking = true;
      utterance.onend = () => {
        speaking = false;
      };
      window.speechSynthesis.speak(utterance);
      lastMessage = message;
      statusDiv.textContent = message;
    }

    // Acceso a la c√°mara
    async function setupCamera() {
      // Priorizamos la c√°mara trasera (environment) para m√≥viles.
      const constraints = { video: { facingMode: 'environment' } };
      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
      } catch (err) {
        console.warn("C√°mara trasera no encontrada, intentando con la frontal.", err);
        // Si falla (ej. en una laptop), intentamos con cualquier c√°mara disponible.
        const fallbackConstraints = { video: true };
        const stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
        video.srcObject = stream;
      }
      
      // A√±adimos un peque√±o efecto visual para indicar que el video est√° activo
      video.style.border = "3px solid #2ea043";
      return new Promise(resolve => {
        video.onloadedmetadata = () => resolve(video);
      });
    }

    // Cargar modelo
    async function loadModel() {
      // Usamos una versi√≥n m√°s ligera del modelo, optimizada para m√≥viles.
      model = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
      statusDiv.textContent = "Modelo cargado ‚úÖ";
      detectFrame(); // Iniciar el bucle de detecci√≥n
    }

    // L√≥gica de detecci√≥n
    async function detectFrame() {
      // Control para no ejecutar la detecci√≥n en cada frame (optimizaci√≥n para m√≥viles)
      const now = performance.now();
      const elapsed = now - lastDetectionTime;
      if (elapsed < 500) { // Ejecutar detecci√≥n ~2 veces por segundo
        detectionLoopId = requestAnimationFrame(detectFrame);
        return;
      }
      lastDetectionTime = now;

      // Si el modelo o el video no est√°n listos, se sigue el bucle pero no se detecta
      if (!model || video.paused || video.ended) {
        detectionLoopId = requestAnimationFrame(detectFrame);
        return;
      }

      const predictions = await model.detect(video);

      let personClose = false;
      let vehicleClose = false;
      let wallDetected = false;
      let message = "Camino libre.";

      for (const obj of predictions) {
        const [x, y, width, height] = obj.bbox;
        const area = width * height;

        if (obj.class === 'person' && area > 30000) personClose = true;
        if ((obj.class === 'car' || obj.class === 'truck' || obj.class === 'bus') && area > 40000) vehicleClose = true;

        // Detectar "pared" o "superficie cercana"
        // Un objeto muy grande que ocupa la mayor parte de la vista.
        if (area > (video.videoWidth * video.videoHeight * 0.6)) wallDetected = true;
      }

      if (wallDetected) message = "Pared al frente, det√©ngase.";
      else if (personClose) message = "Persona al frente, cuidado.";
      else if (vehicleClose) message = "Veh√≠culo cerca, precauci√≥n.";
      else message = "Camino libre.";

      speak(message);
      detectionLoopId = requestAnimationFrame(detectFrame);
    }

    // Funci√≥n principal que se ejecuta al pulsar el bot√≥n
    async function startApp() {
      startButton.style.display = 'none';
      video.style.display = 'block';
      statusDiv.style.display = 'block';
      
      try {
        statusDiv.textContent = "Iniciando c√°mara...";
        await setupCamera();
        statusDiv.textContent = "Cargando modelo...";
        await loadModel();
      } catch (error) {
        console.error("Error al iniciar la aplicaci√≥n:", error);
        // Manejo de errores espec√≠fico para la c√°mara
        if (error.name === "NotAllowedError") {
          statusDiv.textContent = "Permiso de c√°mara denegado. Se requiere acceso para funcionar.";
        } else {
          statusDiv.textContent = "Error al iniciar la c√°mara. Aseg√∫rate de que no est√© en uso.";
        }
      }
    }

    startButton.addEventListener('click', startApp);

  </script>
</body>
</html>