<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Asistente Visual Inteligente</title>

  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdn.jsdelivr.net https://cdn.jsdelivr.net/npm 'unsafe-inline' 'unsafe-eval';
    connect-src *;
    img-src 'self' blob: data:;
    media-src *;
    style-src 'self' 'unsafe-inline';
    object-src 'none';
    frame-ancestors 'none';
  ">

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

  <style>
    :root{--green:#2ea043}
    body{
      background:#0d1117;color:#fff;font-family:Segoe UI,Arial,sans-serif;
      margin:0;padding:18px;text-align:center;
    }
    h1{margin:6px 0 12px;font-size:1.1rem}
    #startButton{
      font-size:1.1rem;padding:10px 22px;background:var(--green);border:none;border-radius:12px;color:#fff;
      cursor:pointer;
    }
    video{width:90%;max-width:480px;border-radius:12px;margin-top:12px;background:#000}
    #status{margin-top:12px;display:inline-block;background:rgba(255,255,255,.08);padding:10px 14px;border-radius:10px}
    #notify{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,.75);padding:8px 12px;border-radius:10px;opacity:0;transition:.25s;color:#fff}
  </style>
</head>
<body>
  <h1>üëÅ Asistente Visual Inteligente</h1>
  <button id="startButton">Iniciar Asistente</button>
  <video id="video" autoplay playsinline muted></video>
  <div id="status">Esperando inicio...</div>
  <div id="notify"></div>

<script>
const startBtn = document.getElementById('startButton');
const statusDiv = document.getElementById('status');
const notifyBox = document.getElementById('notify');
const video = document.getElementById('video');

function notify(msg){
  notifyBox.textContent = msg;
  notifyBox.style.opacity = 1;
  setTimeout(()=> notifyBox.style.opacity = 0, 2200);
}

/* -------- State ---------- */
let cocoModel = null;
let blazeModel = null;
let lastMessage = "";
let speaking = false;
let lastFrameTime = 0;

/* Hysteresis */
const COUNTER_MAX = 8;
const THRESH_GO = 2;
let personCnt = 0, vehicleCnt = 0, wallCnt = 0, groundCnt = 0;

/* ---------- TTS ----------- */
function speak(msg){
  if(!msg) return;
  if(msg === lastMessage && speechSynthesis.speaking) return;

  try{
    if(window.speechSynthesis.speaking){
      window.speechSynthesis.cancel();
    }
    const u = new SpeechSynthesisUtterance(msg);
    u.lang = 'es-MX';
    speaking = true;
    u.onend = () => speaking = false;
    speechSynthesis.speak(u);
    lastMessage = msg;
    statusDiv.textContent = msg;
  }catch(e){ console.warn(e); }
}

/* ---------- Camera ---------- */
async function setupCamera(){
  const constraints = {
    audio:false,
    video:{
      facingMode:{ideal:"environment"},
      width:{ideal:320},
      height:{ideal:240},
      frameRate:{ideal:20, max:24}
    }
  };

  try{
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await new Promise(res => video.onloadedmetadata = res);
    await video.play();
  }catch(err){
    notify('No se puede acceder a la c√°mara.');
    speak('No se puede usar el asistente sin acceso a la c√°mara.');
    throw err;
  }
}

/* ---------- Models ---------- */
async function loadModels(){
  statusDiv.textContent = 'Cargando modelos...';
  notify('Cargando modelos...');

  try{
    await tf.setBackend('webgl');
    await tf.ready();

    cocoModel = await cocoSsd.load({ base:'lite_mobilenet_v2' });
    blazeModel = await blazeface.load();

    statusDiv.textContent = 'Modelos cargados ‚úî';
    notify('Modelos listos');
  }catch(e){
    console.error(e);
    statusDiv.textContent = 'Error cargando modelos';
    notify('Error cargando modelos');
    throw e;
  }
}

/* ---------- Logic helpers ---------- */
function clamp(n,min=0,max=COUNTER_MAX){
  return Math.max(min, Math.min(max, n));
}

function isObstacleOnGroundAdaptive(obj,vw,vh){
  const [x,y,w,h] = obj.bbox;
  const area = w*h;
  const bottom = y+h;
  const groundZone = vh*0.75;
  return bottom > groundZone && area > vw*vh*0.01;
}

/* ---------- Detection loop ---------- */
async function detectLoop(ts){
  if(!ts) ts = performance.now();

  // improve FPS ‚Üí 160ms ‚âà 6FPS
  if(ts - lastFrameTime < 160){
    return requestAnimationFrame(detectLoop);
  }
  lastFrameTime = ts;

  if(!cocoModel || !blazeModel) return requestAnimationFrame(detectLoop);

  let cocoDet = [], blazeDet = [];
  try{
    cocoDet = await cocoModel.detect(video);
    blazeDet = await blazeModel.estimateFaces(video, false);
  }catch(e){
    console.warn('Error detect:', e);
    return requestAnimationFrame(detectLoop);
  }

  const preds = [...cocoDet];
  blazeDet.forEach(face=>{
    preds.push({
      class:'person',
      score:0.9,
      bbox:[
        face.topLeft[0],
        face.topLeft[1],
        face.bottomRight[0]-face.topLeft[0],
        face.bottomRight[1]-face.topLeft[1]
      ]
    });
  });

  const vw = video.videoWidth;
  const vh = video.videoHeight;

  let personPresent=false, vehiclePresent=false, wallPresent=false, groundPresent=false;

  for(const obj of preds){
    const [x,y,w,h] = obj.bbox;
    const area = w*h;

    if(obj.class==='person' && area > vw*vh*0.008) personPresent = true;
    if(['car','truck','bus','motorcycle'].includes(obj.class) && area>vw*vh*0.015) vehiclePresent = true;
    if(area > vw*vh*0.30) wallPresent = true;
    if(isObstacleOnGroundAdaptive(obj,vw,vh)) groundPresent = true;
  }

  personCnt = clamp(personPresent? personCnt+1 : personCnt-1);
  vehicleCnt = clamp(vehiclePresent? vehicleCnt+1 : vehicleCnt-1);
  wallCnt = clamp(wallPresent? wallCnt+1 : wallCnt-1);
  groundCnt = clamp(groundPresent? groundCnt+1 : groundCnt-1);

  const personStable = personCnt >= THRESH_GO;
  const vehicleStable = vehicleCnt >= THRESH_GO;
  const wallStable = wallCnt >= THRESH_GO;
  const groundStable = groundCnt >= THRESH_GO;

  let message = 'Camino libre.';
  if(wallStable) message = 'Pared al frente, det√©ngase.';
  else if(personStable) message = 'Persona al frente, cuidado.';
  else if(vehicleStable) message = 'Veh√≠culo cerca, precauci√≥n.';
  else if(groundStable) message = 'Obst√°culo en el camino.';

  if(message !== lastMessage){
    speak(message);
  }

  requestAnimationFrame(detectLoop);
}

/* ---------- Start ---------- */
async function startApp(){
  startBtn.disabled = true;
  startBtn.style.opacity = "0.6";

  notify('Solicitando c√°mara...');
  statusDiv.textContent = 'Solicitando c√°mara...';

  try{
    await setupCamera();
    await loadModels();

    personCnt = vehicleCnt = wallCnt = groundCnt = 0;
    lastMessage = "";

    notify('Asistente iniciado');
    statusDiv.textContent = 'Asistente iniciado';

    requestAnimationFrame(detectLoop);
  }catch(e){
    statusDiv.textContent = 'Error cr√≠tico.';
    notify('No se pudo iniciar.');
    startBtn.disabled = false;
    startBtn.style.opacity="1";
  }
}

startBtn.addEventListener('click', startApp);
</script>
</body>
</html>
