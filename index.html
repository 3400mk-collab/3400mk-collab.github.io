<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">

  <!-- ========================================================= -->
  <!-- üîí CONTENT-SECURITY-POLICY ULTRA-SEGURA + NONCE DIN√ÅMICO -->
  <!-- ========================================================= -->
  <script>
    // Generamos un nonce seguro
    const nonce = btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(16))));
    document.head.insertAdjacentHTML(
      "beforeend",
      `<meta http="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' https://cdn.jsdelivr.net 'nonce-${nonce}';
          style-src 'self' 'unsafe-inline';
          img-src 'self' blob: data:;
          connect-src *;
          frame-ancestors 'none';
          media-src *;
          object-src 'none';
          base-uri 'self';
          report-uri https://example.com/csp-report;
        ">
      `
    );
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asistente Visual Inteligente</title>

  <!-- TensorFlow.js (con nonce seguro) -->
  <script nonce="">
    document.currentScript.setAttribute("nonce", nonce);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0" nonce=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd" nonce=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface" nonce=""></script>

  <style>
    body {
      background: #0d1117;
      color: #fff;
      font-family: "Segoe UI", sans-serif;
      text-align: center;
      margin: 0;
      padding-top: 20px;
    }
    video {
      width: 90%;
      max-width: 600px;
      border-radius: 16px;
      margin-top: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    #status {
      margin-top: 20px;
      font-size: 1.2em;
      background: rgba(255,255,255,0.1);
      padding: 10px 18px;
      border-radius: 12px;
      display: inline-block;
    }
    #startButton {
      margin-top: 25px;
      font-size: 1.5em;
      padding: 15px 30px;
      background: #2ea043;
      color: white;
      border-radius: 15px;
      border: none;
      cursor: pointer;
    }

    /* Notificaciones */
    #notify {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      padding: 12px 20px;
      border-radius: 10px;
      color: #fff;
      opacity: 0;
      transition: 0.3s;
      pointer-events: none;
      font-size: 1.1em;
    }
  </style>
</head>

<body>

<h2>üëÅ Asistente Visual Inteligente</h2>
<button id="startButton">Iniciar Asistente</button>
<video id="video" autoplay playsinline></video>
<div id="status">Esperando inicio...</div>
<div id="notify"></div>


<!-- ========================================================= -->
<!-- üîí TODO EL JS INTERNO EST√Å AUTORIZADO CON EL MISMO NONCE -->
<!-- ========================================================= -->
<script nonce="">
document.currentScript.setAttribute("nonce", nonce);

/* ---------- Sistema de notificaciones ---------- */
function notify(msg) {
  const box = document.getElementById("notify");
  box.textContent = msg;
  box.style.opacity = 1;
  setTimeout(() => box.style.opacity = 0, 2500);
}

/* --------------- Variables principales --------------- */
let video = document.getElementById("video");
let statusDiv = document.getElementById("status");
let startButton = document.getElementById("startButton");
let cocoModel = null;
let blazeModel = null;

let lastMessage = "";
let speaking = false;
let lastDetectionTime = 0;

/* ----------------- VOZ -------------------- */
function speak(msg) {
  if (speaking || msg === lastMessage) return;
  let u = new SpeechSynthesisUtterance(msg);
  u.lang = "es-MX";
  speaking = true;
  u.onend = () => speaking = false;
  window.speechSynthesis.speak(u);
  lastMessage = msg;
  statusDiv.textContent = msg;
}

/* ------------------ C√°mara segura ------------------ */
async function setupCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });
    video.srcObject = stream;
  } catch {
    notify("No se puede acceder a la c√°mara.");
    speak("No se puede usar el asistente sin la c√°mara.");
    throw new Error("Camera unavailable");
  }

  return new Promise(res => video.onloadedmetadata = () => res());
}

/* ------------------ Modelos ------------------ */
async function loadModels() {
  statusDiv.textContent = "Cargando modelos‚Ä¶";

  try {
    cocoModel = await cocoSsd.load({ base: "lite_mobilenet_v2" });
    blazeModel = await blazeface.load();
    statusDiv.textContent = "Modelos cargados.";
  } catch (e) {
    notify("Error cargando modelos");
    throw e;
  }
}

/* ------------------- Obst√°culos -------------------- */
function isObstacleOnGround(obj) {
  const [x, y, w, h] = obj.bbox;
  return (y + h) > video.videoHeight * 0.65 && w*h > 15000;
}

/* ------------------ Detecci√≥n principal ------------------ */
async function detectFrame() {
  const now = performance.now();
  if (now - lastDetectionTime < 450) return requestAnimationFrame(detectFrame);
  lastDetectionTime = now;

  const cocoDet = await cocoModel.detect(video);
  const blazeDet = await blazeModel.estimateFaces(video, false);

  const predictions = [...cocoDet];

  blazeDet.forEach(face => {
    predictions.push({
      class: "person",
      score: 0.9,
      bbox: [
        face.topLeft[0],
        face.topLeft[1],
        face.bottomRight[0] - face.topLeft[0],
        face.bottomRight[1] - face.topLeft[1]
      ]
    });
  });

  let personClose = false, vehicleClose = false, wallDetected = false, groundObstacle = false;

  predictions.forEach(obj => {
    let [x, y, w, h] = obj.bbox;
    let area = w*h;

    if (obj.class === "person" && area > 30000) personClose = true;
    if (["car","truck","bus"].includes(obj.class) && area > 40000) vehicleClose = true;
    if (area > video.videoWidth * video.videoHeight * 0.60) wallDetected = true;
    if (isObstacleOnGround(obj)) groundObstacle = true;
  });

  let msg = "Camino libre.";
  if (wallDetected) msg = "Pared al frente, det√©ngase.";
  else if (personClose) msg = "Persona al frente, cuidado.";
  else if (vehicleClose) msg = "Veh√≠culo cerca, precauci√≥n.";
  else if (groundObstacle) msg = "Obst√°culo en el camino.";

  speak(msg);
  requestAnimationFrame(detectFrame);
}

/* -------------------- Iniciar app -------------------- */
async function startApp() {
  startButton.style.display = "none";
  notify("Solicitando c√°mara‚Ä¶");

  try {
    await setupCamera();
    notify("C√°mara lista");

    await loadModels();
    notify("Asistente iniciado");

    requestAnimationFrame(detectFrame);
  } catch (e) {
    statusDiv.textContent = "Error cr√≠tico. No se puede iniciar.";
  }
}

startButton.addEventListener("click", startApp);

</script>

</body>
</html>
